
@{
    ViewBag.Title = "AsignarProducto";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section styles{

}

<div class="container-fluid">

    <div class="row">
        <div class="col-sm-12">

            <div class="mb-3" id="accordion">

                <div class="card card-outline card-info">

                    <div class="card-header">
                        <h3 class="card-title">Asignar Productos a Tienda</h3>
                        <button class="btn btn-light btn-sm float-right" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-controls="collapseOne">
                            <i class="fa fa-bars" aria-hidden="true"></i>
                        </button>
                    </div>

                    <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-bs-parent="#accordion">
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-sm-3"><h6 class="m-0">Tienda</h6></div>
                            </div>
                            <div class="row align-items-end">
                                <input id="txtIdTienda" type="hidden" value="0" />
                                <div class="col-sm-2">
                                    <div class="form-group mb-0">
                                        <label for="txtRuc" class="col-form-label col-form-label-sm">RUC:</label>
                                        <input type="text" class="form-control form-control-sm model" readonly id="txtRuc" name="RUC">
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="form-group mb-0">
                                        <label for="txtRazonSocial" class="col-form-label col-form-label-sm">Razón Social:</label>
                                        <input type="text" class="form-control form-control-sm model" readonly id="txtRazonSocial" name="Razon Social">
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="form-group mb-0">
                                        <label for="txtDirecion" class="col-form-label col-form-label-sm">Direccion:</label>
                                        <input type="text" class="form-control form-control-sm model" readonly id="txtDireccion" name="Direccion">
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <div class="form-group mb-0">
                                        <button id="btnBuscarTienda" type="button" class="btn btn-sm btn-success btn-block" onclick="BuscarTienda()"><i class="fas fa-search"></i> Buscar</button>
                                    </div>
                                </div>
                            </div>

                            <hr class="m-2">

                            <div class="row">
                                <div class="col-sm-3"><h6 class="m-0">Producto</h6></div>
                            </div>
                            <div class="row align-items-end">
                                <input id="txtIdProducto" type="hidden" value="0" />
                                <div class="col-sm-2">
                                    <div class="form-group mb-0">
                                        <label for="txtCodigo" class="col-form-label col-form-label-sm">Codigo:</label>
                                        <input type="text" class="form-control form-control-sm model" id="txtCodigo" name="Codigo" autocomplete="off">
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="form-group mb-0">
                                        <label for="txtNombre" class="col-form-label col-form-label-sm">Nombre:</label>
                                        <input type="text" class="form-control form-control-sm model" readonly id="txtNombre" name="Nombre">
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="form-group mb-0">
                                        <label for="txtDescripcion" class="col-form-label col-form-label-sm">Descripción:</label>
                                        <input type="text" class="form-control form-control-sm model" readonly id="txtDescripcion" name="Descripcion">
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <div class="form-group mb-0">
                                        <button id="btnBuscarProducto" type="button" class="btn btn-sm btn-success btn-block" onclick="BuscarProducto()"><i class="fas fa-search"></i> Buscar</button>
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <div class="form-group mb-0">
                                        <button id="btnAsignar" type="button" class="btn btn-sm btn-primary btn-block" onclick="asignarProducto()"><i class="fas fa-clipboard-check"></i> Asignar</button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="card-footer">

                    </div>

                </div>

            </div>

            <div class="card card-outline card-info">
                <div class="card-header bg-info text-white p-2">
                    Lista de Asignaciones
                </div>
                <div id="card-lista" class="card-body p-3">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="table-responsive">
                                <table id="tbdata" class="table table-striped table-bordered nowrap compact" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>Nombre Tienda</th>
                                            <th>RUC Tienda</th>
                                            <th>Codigo Producto</th>
                                            <th>Nombre Producto</th>
                                            <th>Stock</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>


<div class="modal fade" id="modalTienda" tabindex="-1" role="dialog" data-bs-backdrop="static" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Tiendas</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table id="tbTienda" class="table table-striped table-bordered nowrap compact" style="width:100%">
                        <thead>
                            <tr>
                                <th></th>
                                <th>RUC</th>
                                <th>Razón Social</th>
                                <th>Direccion</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-danger" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalProducto" tabindex="-1" data-bs-backdrop="static" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Productos</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table id="tbProducto" class="table table-striped table-bordered nowrap compact" style="width:100%">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Codigo</th>
                                <th>Nombre</th>
                                <th>Descripcion</th>
                                <th>Categoria</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-danger" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>


@section scripts{
    <script>
        var dtTienda;
        var dtProducto;
        var dtData;

        ShowLoading();

        $(function () {
            HideLoading();
            Title("Asignar Producto");

            ////validamos el formulario
            $("#form").validate({
                rules: {
                    Nombre: "required",
                    Descripcion: "required"
                },
                messages: {
                    Nombre: "(*)",
                    Descripcion: "(*)"

                },
                errorElement: 'span'
            });


            dtTienda = GetDataTable({
                TableId: '#tbTienda',
                Url: '@Url.Action("ListarTiendas", "Acceso")',
                Columns: [
                    {
                        "data": "IdTienda", "render": function (data, type, row, meta) {
                            return "<button class='btn btn-sm btn-primary ml-2' type='button' onclick='TiendaSelect(" + JSON.stringify(row) + ")'><i class='fas fa-check'></i></button>"
                        },
                        "orderable": false,
                        "searchable": false,
                        "width": "90px"
                    },
                    { "data": "RUC" },
                    { "data": "Nombre" },
                    { "data": "Direccion" }
                ] 
            });

            dtProducto = GetDataTable({
                TableId: '#tbProducto',
                Url: '@Url.Action("ListarProductos", "Almacen")',
                Columns: [
                    {
                        "data": "IdProducto", "render": function (data, type, row, meta) {
                            return "<button class='btn btn-sm btn-primary ml-2' type='button' onclick='ProductoSelect(" + JSON.stringify(row) + ")'><i class='fas fa-check'></i></button>"
                        },
                        "orderable": false,
                        "searchable": false,
                        "width": "90px"
                    },
                    { "data": "Codigo" },
                    { "data": "Nombre" },
                    { "data": "Descripcion" },
                    {
                        "data": "oCategoria", render: function (data) {
                            return data.Descripcion
                        }
                    }
                ] 
            });

            dtData = GetDataTable({
                TableId: '#tbdata',
                Url: '@Url.Action("ListarAsignaciones", "Compra")',
                Columns: [
                    { "data": "oTienda", render: function (data) { return data.Nombre } },
                    { "data": "oTienda", render: function (data) { return data.RUC } },
                    { "data": "oProducto", render: function (data) { return data.Codigo } },
                    { "data": "oProducto", render: function (data) { return data.Nombre } },
                    { "data": "Stock" },
                    {
                        "data": "IdProductoTienda", "render": function (data, type, row, meta) {
                            return "<button class='btn btn-danger btn-sm ml-2' type='button' onclick='eliminar(" + data + ")'><i class='fa fa-trash'></i></button>"
                        },
                        "orderable": false,
                        "searchable": false,
                        "width": "80px"
                    }

                ] 
            });
       
        });


        function BuscarTienda() {
            dtTienda.ajax.reload();
            $('#modalTienda').modal('show');
        }

        function BuscarProducto() {
            dtProducto.ajax.reload();
            $('#modalProducto').modal('show');
        }

        function TiendaSelect(json) {
            $("#txtIdTienda").val(json.IdTienda);
            $("#txtRuc").val(json.RUC);
            $("#txtRazonSocial").val(json.Nombre);
            $("#txtDireccion").val(json.Direccion);

            $('#modalTienda').modal('hide');
        }

        function ProductoSelect(json) {
            $("#txtIdProducto").val(json.IdProducto);
            $("#txtCodigo").val(json.Codigo);
            $("#txtNombre").val(json.Nombre);
            $("#txtDescripcion").val(json.Descripcion);

            $('#modalProducto').modal('hide');
        }

        $("#txtCodigo").on('keypress', function (e) {

            if (e.which == 13) {

                //OBTENER PRODUCTOS
                AjaxGet({
                    TableId: '@Url.Action("ListarProductos", "Almacen")',
                    tloading: "#txtCodigo",
                    success: (data) => {

                        var encontrado = false;
                        if (data.data != null) {
                            $.each(data.data, function (i, item) {
                                if (item.Activo == true && item.Codigo == $("#txtCodigo").val()) {

                                    $("#txtIdProducto").val(item.IdProducto);
                                    $("#txtCodigo").val(item.Codigo);
                                    $("#txtNombre").val(item.Nombre);
                                    $("#txtDescripcion").val(item.Descripcion);

                                    encontrado = true;
                                    return false;
                                }
                            })

                            if (!encontrado) {
                                $("#txtIdProducto").val("0");
                                $("#txtNombre").val("");
                                $("#txtDescripcion").val("");
                            }
                        }

                    }
                });

            }
        });

        function asignarProducto() {

            var camposvacios = false;

            if ($("#txtIdTienda").val() == "0" || $("#txtIdProducto").val() == "0")
                camposvacios = true;

            if (!camposvacios) {

                var request = {
                    objeto: {
                        oProducto: { IdProducto: parseInt($("#txtIdProducto").val()) },
                        oTienda: { IdTienda: parseInt($("#txtIdTienda").val()) },
                    }
                }

                AjaxPost({
                    url: '@Url.Action("RegistrarProductoTienda", "Compra")',
                    obj: request,
                    success: (data) => {

                        if (data.resultado) {
                            MsgSuccessSE(0);
                            dtData.ajax.reload();
                            $("#txtIdProducto").val("0");
                            $("#txtCodigo").val("");
                            $("#txtNombre").val("");
                            $("#txtDescripcion").val("");
                        } else {
                            MsgError(data.mensaje);
                            Swal.fire("Mensaje", "No se pudo registrar la asignación", "warning")
                        }

                    }                   
                });

             
            } else {
                Swal.fire("Mensaje!", "Es necesario completar todos los campos", "warning")
            }


        }

        function eliminar($id) {

            Swal.fire({
                icon: "warning",
                title: "Mensaje",
                text: "¿Desea eliminar la asignación?",
                showCancelButton: true,
                confirmButtonText: "Si",
                confirmButtonColor: "#DD6B55",
                cancelButtonText: "No",
                closeOnConfirm: true
            }).then((result) => {
                if (result.isConfirmed) {

                    AjaxGet({
                        url: '@Url.Action("EliminarProductoTienda", "Compra")' + "?id=" + $id,
                        success: (data) => {

                            if (data.resultado) {
                                tabladata.ajax.reload();
                            } else {
                                Swal.fire("Mensaje", "No se pudo eliminar la asignación?", "warning")
                            }
                        }
                    });
                }                  
            });
        }


    </script>
}
